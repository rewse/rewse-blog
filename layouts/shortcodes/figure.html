{{/*
  Figure shortcode with optimized image support.
  Uses pre-optimized images from static/img/optimized/ when available,
  falls back to Hugo's image processing otherwise.
*/}}

{{- $disableImageOptimization := .Site.Params.disableImageOptimization | default false -}}

{{ if .Get "default" }}
  {{ partial "hugo-embedded/shortcodes/figure-default.html" . }}
{{ else }}
  {{- $url := urls.Parse (.Get "src") -}}
  {{- $altText := .Get "alt" -}}
  {{- $caption := .Get "caption" -}}
  {{- $href := .Get "href" -}}
  {{- $class := .Get "class" -}}
  {{- $target := .Get "target" | default "_blank" -}}
  {{- $nozoom := .Get "nozoom" | default false -}}
  {{- $imgClass := printf "my-0 rounded-md%s%s" (cond $nozoom " nozoom" "") (cond (ne $class "") (printf " %s" $class) "") -}}

  <figure>
  {{- with $href }}<a href="{{ . }}" {{ with $target }}target="{{ . }}"{{ end }} class="inline-block">{{ end -}}

  {{- if findRE "^https?" $url.Scheme -}}
    {{/* Remote image */}}
    <img class="{{ $imgClass }}" src="{{ $url.String }}" alt="{{ $altText }}" />

  {{- else -}}
    {{- $resource := "" -}}
    {{- if $.Page.Resources.GetMatch ($url.String) -}}
      {{- $resource = $.Page.Resources.GetMatch ($url.String) -}}
    {{- else if resources.GetMatch ($url.String) -}}
      {{- $resource = resources.Get ($url.String) -}}
    {{- end -}}

    {{- with $resource -}}
      {{- if or $disableImageOptimization (eq .MediaType.SubType "svg") -}}
        {{/* SVG or optimization disabled */}}
        <img class="{{ $imgClass }}" src="{{ .RelPermalink }}" alt="{{ $altText }}" />

      {{- else -}}
        {{/* Build source path for optimized image lookup */}}
        {{- $sourcePath := "" -}}
        {{- with $.Page.File -}}
          {{- $sourcePath = printf "%s/%s" (path.Dir .Path) ($url.String) -}}
        {{- end -}}

        {{- $optimizedExists := false -}}
        {{- if $sourcePath -}}
          {{- $optimizedExists = partial "image/exists.html" $sourcePath -}}
        {{- end -}}

        {{- if $optimizedExists -}}
          {{- partial "image/optimized.html" (dict
            "source" $sourcePath
            "widths" (slice 800 1600)
            "sizes" "(min-width: 768px) 700px, 100vw"
            "alt" $altText
            "class" $imgClass
            "imgObj" .
          ) -}}
        {{- else -}}
          {{- partial "image/fallback.html" (dict
            "imgObj" .
            "widths" (slice 800 1600)
            "sizes" "(min-width: 768px) 700px, 100vw"
            "alt" $altText
            "class" $imgClass
          ) -}}
        {{- end -}}
      {{- end -}}

    {{- else -}}
      {{/* Resource not found */}}
      <img class="{{ $imgClass }}" src="{{ $url.String }}" alt="{{ $altText }}" />
    {{- end -}}
  {{- end -}}

  {{- if $href }}</a>{{ end -}}
  {{- with $caption }}<figcaption>{{ . | markdownify }}</figcaption>{{ end -}}
  </figure>
{{- end -}}
