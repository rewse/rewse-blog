{{ $disableImageOptimization := .Site.Params.disableImageOptimization | default false }}
{{ if .Get "default" }}
  {{ partial "hugo-embedded/shortcodes/figure-default.html" . }}
{{ else }}
  {{- $url := urls.Parse (.Get "src") }}
  {{- $altText := .Get "alt" }}
  {{- $caption := .Get "caption" }}
  {{- $href := .Get "href" }}
  {{- $class := .Get "class" }}
  {{- $target := .Get "target" | default "_blank" }}
  {{- $nozoom := .Get "nozoom" | default false -}}

  <figure>
  {{- with $href }}<a href="{{ . }}" {{ with $target }}target="{{ . }}"{{ end }} class="inline-block">{{ end -}}
  {{- if findRE "^https?" $url.Scheme }}
      <img class="my-0 rounded-md{{ with $nozoom }} nozoom{{ end }}{{ with $class }} {{ . }}{{ end }}" src="{{ $url.String }}" alt="{{ $altText }}" />
  {{- else }}
    {{- $resource := "" }}
    {{- if $.Page.Resources.GetMatch ($url.String) }}
      {{- $resource = $.Page.Resources.GetMatch ($url.String) }}
    {{- else if resources.GetMatch ($url.String) }}
      {{- $resource = resources.Get ($url.String) }}
    {{- end }}
    {{- with $resource }}
      {{- if or $disableImageOptimization (eq .MediaType.SubType "svg")}}
        <img
          class="my-0 rounded-md{{ with $nozoom }} nozoom{{ end }}{{ with $class }} {{ . }}{{ end }}"
          src="{{ .RelPermalink }}"
          alt="{{ $altText }}"
        />
      {{- else }}
        {{- $targetWidthSmall := 800 -}}
        {{- $targetWidthLarge := 1600 -}}
        {{- $actualWidth := .Width -}}
        {{- $widthSmall := 0 -}}
        {{- $widthLarge := 0 -}}
        {{- $imgSmall := "" -}}
        {{- $imgLarge := "" -}}
        {{- $imgSmallWebp := "" -}}
        {{- $imgLargeWebp := "" -}}

        {{/* Generate small version */}}
        {{- if ge $actualWidth $targetWidthSmall -}}
          {{- $widthSmall = $targetWidthSmall -}}
          {{- $imgSmall = .Resize (printf "%dx" $targetWidthSmall) -}}
          {{- $imgSmallWebp = .Resize (printf "%dx webp" $targetWidthSmall) -}}
        {{- else -}}
          {{- $widthSmall = $actualWidth -}}
          {{- $imgSmall = . -}}
        {{- end -}}

        {{/* Generate large version */}}
        {{- if ge $actualWidth $targetWidthLarge -}}
          {{- $widthLarge = $targetWidthLarge -}}
          {{- $imgLarge = .Resize (printf "%dx" $targetWidthLarge) -}}
          {{- $imgLargeWebp = .Resize (printf "%dx webp" $targetWidthLarge) -}}
        {{- else if gt $actualWidth $targetWidthSmall -}}
          {{- $widthLarge = $actualWidth -}}
          {{- $imgLarge = . -}}
          {{- $imgLargeWebp = .Resize (printf "%dx webp" $actualWidth) -}}
        {{- end -}}

        <picture>
          {{- if and $imgSmallWebp $imgLargeWebp }}
          <source
            srcset="{{ $imgSmallWebp.RelPermalink }} {{ $widthSmall }}w, {{ $imgLargeWebp.RelPermalink }} {{ $widthLarge }}w"
            sizes="(min-width: 768px) 700px, 100vw"
            type="image/webp">
          {{- else if $imgSmallWebp }}
          <source srcset="{{ $imgSmallWebp.RelPermalink }}" type="image/webp">
          {{- end }}
          <img
            class="my-0 rounded-md{{ with $nozoom }} nozoom{{ end }}{{ with $class }} {{ . }}{{ end }}"
            loading="lazy"
            decoding="async"
            fetchpriority="auto"
            alt="{{ $altText }}"
            {{ with .Width }}width="{{ . }}"{{ end }}
            {{ with .Height }}height="{{ . }}"{{ end }}
            src="{{ $imgSmall.RelPermalink }}"
            {{- if and $imgSmall $imgLarge }}
            srcset="{{ $imgSmall.RelPermalink }} {{ $widthSmall }}w, {{ $imgLarge.RelPermalink }} {{ $widthLarge }}w"
            sizes="(min-width: 768px) 700px, 100vw"
            {{- end }}
            data-zoom-src="{{ .RelPermalink }}"
          />
        </picture>
      {{- end }}
    {{- else }}
      <img class="my-0 rounded-md{{ with $nozoom }} nozoom{{ end }}{{ with $class }} {{ . }}{{ end }}" src="{{ $url.String }}" alt="{{ $altText }}" />
    {{- end }}
  {{- end }}
  {{ if $href }}</a>{{ end }}
  {{ with $caption }}<figcaption>{{ . | markdownify }}</figcaption>{{ end }}
  </figure>
{{- end -}}
