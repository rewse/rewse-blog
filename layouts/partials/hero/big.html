{{/*
  Big hero image partial.
  Uses pre-optimized images when available, falls back to Hugo processing.
*/}}

{{ $disableImageOptimization := site.Store.Get "disableImageOptimization" }}

{{ $useDefault := false }}
{{ $featured := "" }}
{{ $featuredURL := "" }}
{{ $filename := "" }}

{{/* Get featured image from frontmatter */}}
{{ with .Params.featureimage }}
  {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
    {{ if site.Params.hotlinkFeatureImage }}
      {{ $featuredURL = . }}
    {{ else }}
      {{ $featured = resources.GetRemote . }}
    {{ end }}
  {{ else }}
    {{ $featured = resources.Get . }}
    {{ $filename = . }}
  {{ end }}
{{ end }}

{{/* Fallback to page resources */}}
{{ if not (or $featured $featuredURL) }}
  {{ $images := .Resources.ByType "image" }}
  {{ range slice "*background*" "*feature*" "*cover*" "*thumbnail*" }}
    {{ if not $featured }}
      {{ $match := $images.GetMatch . }}
      {{ if $match }}
        {{ $featured = $match }}
        {{ $filename = path.Base $match.Name }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fallback to default background image */}}
{{ if not (or $featured $featuredURL) }}
  {{ $default := site.Store.Get "defaultBackgroundImage" }}
  {{ if $default.url }}
    {{ $featuredURL = $default.url }}
    {{ $useDefault = true }}
  {{ else if $default.obj }}
    {{ $featured = $default.obj }}
    {{ $useDefault = true }}
  {{ end }}
{{ end }}

{{ $caption := "" }}
{{ with .Params.featureimagecaption }}
  {{ $caption = . }}
{{ end }}

{{ $alt := .Page.Title }}
{{ with .Page.Params.alt }}{{ $alt = . }}{{ end }}

{{ $style := "" }}
{{ $defaultPosition := cond $useDefault site.Params.imagePosition false }}
{{ with $.Params.imagePosition | default $defaultPosition }}
  {{ $style = printf "object-position: %s;" . }}
{{ end }}

{{ $imgClass := "w-full rounded-lg single_hero_round nozoom" }}

{{ if $featuredURL }}
  {{/* Hotlinked image - no processing */}}
  <figure>
    <img
      src="{{ $featuredURL }}"
      alt="{{ $alt }}"
      loading="eager"
      decoding="async"
      fetchpriority="high"
      class="{{ $imgClass }}"
      {{ with $style }}style="{{ . | safeCSS }}"{{ end }}>
    {{ with $caption }}
      <figcaption class="text-sm text-neutral-700 dark:text-neutral-400 hover:underline text-center">
        {{ . | markdownify }}
      </figcaption>
    {{ end }}
  </figure>

{{ else if $featured }}
  {{ $isSVG := eq $featured.MediaType.SubType "svg" }}
  
  {{ if or $disableImageOptimization $isSVG }}
    {{/* SVG or optimization disabled */}}
    <figure>
      <img
        src="{{ $featured.RelPermalink }}"
        alt="{{ $alt }}"
        loading="eager"
        decoding="async"
        fetchpriority="high"
        class="{{ $imgClass }}"
        {{ with $style }}style="{{ . | safeCSS }}"{{ end }}>
      {{ with $caption }}
        <figcaption class="text-sm text-neutral-700 dark:text-neutral-400 hover:underline text-center">
          {{ . | markdownify }}
        </figcaption>
      {{ end }}
    </figure>

  {{ else }}
    {{/* Check for optimized image */}}
    {{ $sourcePath := "" }}
    {{ if and $.Page.File $filename }}
      {{ $sourcePath = printf "%s/%s" (path.Dir $.Page.File.Path) $filename }}
    {{ end }}
    
    {{ $optimizedExists := false }}
    {{ if $sourcePath }}
      {{ $optimizedExists = partial "image/exists.html" (dict "source" $sourcePath "width" 1200) }}
    {{ end }}

    <figure>
      {{ if $optimizedExists }}
        {{ partial "image/optimized.html" (dict
          "source" $sourcePath
          "widths" (slice 1200 2400)
          "sizes" "100vw"
          "alt" $alt
          "class" $imgClass
          "imgObj" $featured
          "loading" "eager"
          "fetchpriority" "high"
        ) }}
      {{ else }}
        {{/* Fallback to Hugo processing */}}
        {{ partial "image/fallback.html" (dict
          "imgObj" $featured
          "widths" (slice 1200 2400)
          "sizes" "100vw"
          "alt" $alt
          "class" $imgClass
          "loading" "eager"
          "fetchpriority" "high"
        ) }}
      {{ end }}
      {{ with $caption }}
        <figcaption class="text-sm text-neutral-700 dark:text-neutral-400 hover:underline text-center">
          {{ . | markdownify }}
        </figcaption>
      {{ end }}
    </figure>
  {{ end }}
{{ end }}
