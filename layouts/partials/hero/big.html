{{ $disableImageOptimization := site.Store.Get "disableImageOptimization" }}

{{ $useDefault := false }}
{{ $featured := "" }}
{{ $featuredURL := "" }}
{{ $featuredURLSmall := "" }}
{{ $featuredURLLarge := "" }}
{{ $featuredURLWebpSmall := "" }}
{{ $featuredURLWebpLarge := "" }}
{{ $widthSmall := 0 }}
{{ $widthLarge := 0 }}
{{ with .Params.featureimage }}
  {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
    {{ if site.Params.hotlinkFeatureImage }}
      {{ $featuredURL = . }}
    {{ else }}
      {{ $featured = resources.GetRemote . }}
    {{ end }}
  {{ else }}
    {{ $featured = resources.Get . }}
  {{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
  {{ $images := .Resources.ByType "image" }}
  {{ range slice "*background*" "*feature*" "*cover*" "*thumbnail*" }}
    {{ if not $featured }}{{ $featured = $images.GetMatch . }}{{ end }}
  {{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
  {{ $default := site.Store.Get "defaultBackgroundImage" }}
  {{ if $default.url }}
    {{ $featuredURL = $default.url }}
    {{ $useDefault = true }}
  {{ else if $default.obj }}
    {{ $featured = $default.obj }}
    {{ $useDefault = true }}
  {{ end }}
{{ end }}

{{/* generate image URLs for srcset with w descriptor */}}
{{ if not $featuredURL }}
  {{ with $featured }}
    {{ if not (or $disableImageOptimization (eq .MediaType.SubType "svg")) }}
      {{ $targetWidthLarge := 2400 }}
      {{ $targetWidthSmall := 1200 }}
      {{ if site.Params.backgroundImageWidth }}
        {{ $targetWidthLarge = site.Params.backgroundImageWidth }}
        {{ $targetWidthSmall = div $targetWidthLarge 2 }}
      {{ end }}
      {{ $actualWidth := .Width }}
      
      {{/* Generate small version */}}
      {{ if ge $actualWidth $targetWidthSmall }}
        {{ $widthSmall = $targetWidthSmall }}
        {{ $featuredURLSmall = (.Resize (printf "%dx" $targetWidthSmall)).RelPermalink }}
        {{ $featuredURLWebpSmall = (.Resize (printf "%dx webp" $targetWidthSmall)).RelPermalink }}
      {{ else }}
        {{ $widthSmall = $actualWidth }}
        {{ $featuredURLSmall = .RelPermalink }}
      {{ end }}
      
      {{/* Generate large version */}}
      {{ if ge $actualWidth $targetWidthLarge }}
        {{ $widthLarge = $targetWidthLarge }}
        {{ $featuredURLLarge = (.Resize (printf "%dx" $targetWidthLarge)).RelPermalink }}
        {{ $featuredURLWebpLarge = (.Resize (printf "%dx webp" $targetWidthLarge)).RelPermalink }}
      {{ else if gt $actualWidth $targetWidthSmall }}
        {{ $widthLarge = $actualWidth }}
        {{ $featuredURLLarge = .RelPermalink }}
        {{ $featuredURLWebpLarge = (.Resize (printf "%dx webp" $actualWidth)).RelPermalink }}
      {{ end }}
    {{ else }}
      {{/* SVG or optimization disabled - use original */}}
      {{ $featuredURL = .RelPermalink }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $caption := "" }}
{{ if .Params.featureimagecaption }}
  {{- $caption = .Params.featureimagecaption -}}
{{ end }}

{{- $alt := .Page.Title -}}
{{- with .Page.Params.alt }}{{ $alt = . }}{{ end -}}

{{ if or $featuredURL $featuredURLSmall }}
  {{ $style := "" }}
  {{ $defaultPosition := cond $useDefault site.Params.imagePosition false }}
  {{ with $.Params.imagePosition | default $defaultPosition }}
    {{ $style = printf "object-position: %s;" . }}
  {{ end }}
  <figure>
    {{ if $featuredURL }}
      {{/* Hotlinked image - no srcset */}}
      <img
        src="{{ $featuredURL }}"
        alt="{{ $alt }}"
        loading="eager"
        decoding="async"
        fetchpriority="high"
        class="w-full rounded-lg single_hero_round nozoom"
        {{ if $style }}style="{{ $style | safeCSS }}"{{ end }}>
    {{ else if or $featuredURLWebpSmall $featuredURLWebpLarge }}
      {{/* WebP available - use picture with srcset */}}
      <picture>
        {{ if and $featuredURLWebpSmall $featuredURLWebpLarge }}
          <source
            srcset="{{ $featuredURLWebpSmall }} {{ $widthSmall }}w, {{ $featuredURLWebpLarge }} {{ $widthLarge }}w"
            sizes="100vw"
            type="image/webp">
        {{ else if $featuredURLWebpSmall }}
          <source srcset="{{ $featuredURLWebpSmall }}" type="image/webp">
        {{ end }}
        <img
          {{ if and $featuredURLSmall $featuredURLLarge }}
            srcset="{{ $featuredURLSmall }} {{ $widthSmall }}w, {{ $featuredURLLarge }} {{ $widthLarge }}w"
            sizes="100vw"
          {{ end }}
          src="{{ $featuredURLSmall }}"
          alt="{{ $alt }}"
          loading="eager"
          decoding="async"
          fetchpriority="high"
          class="w-full rounded-lg single_hero_round nozoom"
          {{ if $style }}style="{{ $style | safeCSS }}"{{ end }}>
      </picture>
    {{ else }}
      {{/* No WebP - use img with srcset */}}
      <img
        {{ if and $featuredURLSmall $featuredURLLarge }}
          srcset="{{ $featuredURLSmall }} {{ $widthSmall }}w, {{ $featuredURLLarge }} {{ $widthLarge }}w"
          sizes="100vw"
        {{ end }}
        src="{{ $featuredURLSmall }}"
        alt="{{ $alt }}"
        loading="eager"
        decoding="async"
        fetchpriority="high"
        class="w-full rounded-lg single_hero_round nozoom"
        {{ if $style }}style="{{ $style | safeCSS }}"{{ end }}>
    {{ end }}
    {{ if $caption }}
      <figcaption class="text-sm text-neutral-700 dark:text-neutral-400 hover:underline text-center">
        {{ $caption | markdownify }}
      </figcaption>
    {{ end }}
  </figure>
{{ end }}
