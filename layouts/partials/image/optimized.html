{{/*
  Generate <picture> element using pre-optimized images from static/img/optimized/.
  
  Input: dict with:
    - source: content-relative image path (e.g., "posts/my-post/image.jpg")
    - widths: slice of widths to use (e.g., slice 800 1600)
    - sizes: sizes attribute value (e.g., "(min-width: 768px) 50vw, 100vw")
    - alt: alt text
    - class: CSS classes (optional)
    - imgObj: Hugo image resource for width/height (optional)
    - loading: loading attribute (default: "lazy")
    - fetchpriority: fetchpriority attribute (default: "auto")
    - zoomSrc: data-zoom-src path (optional, uses largest width if not specified)
*/}}

{{- $source := .source -}}
{{- $widths := .widths -}}
{{- $sizes := .sizes -}}
{{- $alt := .alt | default "" -}}
{{- $class := .class | default "" -}}
{{- $imgObj := .imgObj -}}
{{- $loading := .loading | default "lazy" -}}
{{- $fetchpriority := .fetchpriority | default "auto" -}}
{{- $zoomSrc := .zoomSrc -}}

{{/* Handle /img/ prefix - these are stored directly in optimized root */}}
{{- $cleanSource := $source -}}
{{- if strings.HasPrefix $source "/img/" -}}
  {{- $cleanSource = strings.TrimPrefix "/img/" $source -}}
{{- end -}}

{{- $dir := path.Dir $cleanSource -}}
{{- $base := path.BaseName $cleanSource -}}
{{- $ext := path.Ext $cleanSource -}}

{{/* Load manifest to get hash */}}
{{- $manifestPath := "static/img/optimized/.manifest.json" -}}
{{- $manifest := dict -}}
{{- if fileExists $manifestPath -}}
  {{- $manifestContent := readFile $manifestPath -}}
  {{- $manifest = $manifestContent | unmarshal -}}
{{- end -}}

{{/* Find source path in manifest */}}
{{- $sourceKey := "" -}}
{{- $hash := "" -}}
{{- $contentPath := printf "content/%s" $cleanSource -}}
{{- range $key, $value := $manifest.processed -}}
  {{- if or (eq $key $source) (eq $key $contentPath) (eq $key (printf "assets/img/%s" $cleanSource)) -}}
    {{- $sourceKey = $key -}}
    {{- $hash = substr $value.hash 0 8 -}}
  {{- end -}}
{{- end -}}

{{/* Build base path depending on whether file is in root or subdirectory */}}
{{- $basePath := "" -}}
{{- if eq $dir "." -}}
  {{- $basePath = printf "/img/optimized/%s" $base -}}
{{- else -}}
  {{- $basePath = printf "/img/optimized/%s/%s" $dir $base -}}
{{- end -}}

{{/* Build srcset strings with hash */}}
{{- $srcsetAvif := slice -}}
{{- $srcsetOrig := slice -}}
{{- $smallestSrc := "" -}}
{{- $largestSrc := "" -}}

{{- if $hash -}}
  {{- range $widths -}}
    {{- $w := . -}}
    {{- $avif := printf "%s-%dw-%s.avif %dw" $basePath $w $hash $w -}}
    {{- $orig := printf "%s-%dw-%s%s %dw" $basePath $w $hash $ext $w -}}
    {{- $srcsetAvif = $srcsetAvif | append $avif -}}
    {{- $srcsetOrig = $srcsetOrig | append $orig -}}
    {{- if not $smallestSrc -}}
      {{- $smallestSrc = printf "%s-%dw-%s%s" $basePath $w $hash $ext -}}
    {{- end -}}
    {{- $largestSrc = printf "%s-%dw-%s%s" $basePath $w $hash $ext -}}
  {{- end -}}
{{- else -}}
  {{/* Fallback to original source if hash not found */}}
  {{- $smallestSrc = $source -}}
  {{- $largestSrc = $source -}}
{{- end -}}

{{- if not $zoomSrc -}}
  {{- $zoomSrc = $largestSrc -}}
{{- end -}}

<picture{{ with .pictureClass }} class="{{ . }}"{{ end }}>
  {{- if $hash -}}
  <source
    srcset="{{ delimit $srcsetAvif ", " }}"
    sizes="{{ $sizes }}"
    type="image/avif">
  {{- end -}}
  <img
    {{- if $class }}
    class="{{ $class }}"
    {{- end }}
    loading="{{ $loading }}"
    decoding="async"
    fetchpriority="{{ $fetchpriority }}"
    alt="{{ $alt }}"
    {{- with $imgObj }}
    {{ with .Width }}width="{{ . }}"{{ end }}
    {{ with .Height }}height="{{ . }}"{{ end }}
    {{- end }}
    src="{{ $smallestSrc }}"
    {{- if $hash }}
    srcset="{{ delimit $srcsetOrig ", " }}"
    sizes="{{ $sizes }}"
    {{- end }}
    {{- with .style }}
    style="{{ . | safeCSS }}"
    {{- end }}
    data-zoom-src="{{ $zoomSrc }}">
</picture>
