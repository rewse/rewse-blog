{{/*
  Render hook for Markdown images.
  Uses pre-optimized images from static/img/optimized/ when available,
  falls back to Hugo's image processing otherwise.
*/}}

{{- $disableImageOptimizationMD := .Page.Site.Params.disableImageOptimizationMD | default false -}}
{{- $urlStr := .Destination | safeURL -}}
{{- $url := urls.Parse $urlStr -}}
{{- $altText := .Text -}}
{{- $caption := .Title -}}
{{- $isRemote := findRE "^(https?|data)" $url.Scheme -}}
{{- $resource := "" -}}

{{- if not $isRemote -}}
  {{- $resource = or ($.Page.Resources.GetMatch $urlStr) (resources.Get $urlStr) -}}
{{- end -}}

<figure
  {{- range $k, $v := .Attributes -}}
    {{- if $v -}}
      {{- printf " %s=%q" $k ($v | transform.HTMLEscape) | safeHTMLAttr -}}
    {{- end -}}
  {{- end -}}>

  {{- if $isRemote -}}
    {{/* Remote image - no processing */}}
    <img
      class="my-0 rounded-md"
      loading="lazy"
      decoding="async"
      fetchpriority="low"
      alt="{{ $altText }}"
      src="{{ $urlStr }}">

  {{- else if $resource -}}
    {{- $isSVG := eq $resource.MediaType.SubType "svg" -}}
    {{- $shouldOptimize := and (not $disableImageOptimizationMD) (not $isSVG) -}}

    {{- if $shouldOptimize -}}
      {{/* Build source path for optimized image lookup */}}
      {{- $sourcePath := "" -}}
      {{- with $.Page.File -}}
        {{- $sourcePath = printf "%s/%s" (path.Dir .Path) $urlStr -}}
      {{- end -}}

      {{- $optimizedExists := false -}}
      {{- if $sourcePath -}}
        {{- $optimizedExists = partial "image/exists.html" $sourcePath -}}
      {{- end -}}

      {{- if $optimizedExists -}}
        {{- partial "image/optimized.html" (dict
          "source" $sourcePath
          "widths" (slice 800 1600)
          "sizes" "(min-width: 768px) 50vw, 65vw"
          "alt" $altText
          "class" "my-0 rounded-md"
          "imgObj" $resource
        ) -}}
      {{- else -}}
        {{- partial "image/fallback.html" (dict
          "imgObj" $resource
          "widths" (slice 800 1600)
          "sizes" "(min-width: 768px) 50vw, 65vw"
          "alt" $altText
          "class" "my-0 rounded-md"
        ) -}}
      {{- end -}}

    {{- else -}}
      {{/* SVG or optimization disabled */}}
      <img
        class="my-0 rounded-md"
        loading="lazy"
        decoding="async"
        fetchpriority="low"
        alt="{{ $altText }}"
        src="{{ $resource.RelPermalink }}"
        {{- if not $isSVG }}
        {{ with $resource.Width }}width="{{ . }}"{{ end }}
        {{ with $resource.Height }}height="{{ . }}"{{ end }}
        {{- end }}>
    {{- end -}}

  {{- else -}}
    {{/* Resource not found - use URL as-is */}}
    <img
      class="my-0 rounded-md"
      loading="lazy"
      decoding="async"
      fetchpriority="low"
      alt="{{ $altText }}"
      src="{{ $urlStr }}">
  {{- end -}}

  {{- with $caption }}
  <figcaption>{{ . | markdownify }}</figcaption>
  {{- end -}}
</figure>
