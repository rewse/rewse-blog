version: 1
env:
  variables:
    HUGO_VERSION: 0.154.2
    TZ: Asia/Tokyo
    OPTIMIZED_IMAGES_DIR: static/img/optimized
frontend:
  phases:
    preBuild:
      commands:
        - echo "Creating directory for Hugo..."
        - mkdir -p "${HOME}/.local/hugo"

        - echo "Installing Hugo ${HUGO_VERSION}..."
        - curl -sLJO "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        - tar -C "${HOME}/.local/hugo" -xf "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        - rm "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        - 'export PATH="${HOME}/.local/hugo:${PATH}"'

        - echo "Verifying installations..."
        - echo "Hugo ->" $(hugo version)
        - echo "uv ->" $(uv --version)
        - echo "vips ->" $(vips --version)

        - echo "Checking AVIF support..."
        - echo "libheif version ->" $(pkg-config --modversion libheif 2>/dev/null || echo "not found")
        - echo "rav1e available ->" $(which rav1e || echo "not found")
        - echo "librav1e0 installed ->" $(dpkg -l | grep librav1e0 || echo "not found")
        - echo "vips formats ->" $(vips -l | grep -E "(heif|avif)" || echo "no HEIF/AVIF support found")

        - echo "Checking image cache status..."
        - echo "OPTIMIZED_IMAGES_DIR ->" ${OPTIMIZED_IMAGES_DIR}
        - echo "Looking for manifest file ->"
        - ls -la ${OPTIMIZED_IMAGES_DIR}/.manifest.json || echo "Manifest file not found"
        - echo "Total files in optimized directory ->"
        - find ${OPTIMIZED_IMAGES_DIR}/ -type f | wc -l || echo "0"

        - echo "Running image optimization..."
        # - bash scripts/clean_optimized_images.sh
        - uv run --with pyvips scripts/optimize_images.py || uv run --with pyvips scripts/optimize_images.py
    build:
      commands:
        - hugo --gc --minify
    postBuild:
      commands:
        - echo "Checking resources/_gen directory contents..."
        - echo "Files in resources/_gen ->"
        - find resources/_gen -type f 2>/dev/null | sort | head -100 || echo "resources/_gen directory not found or empty"
        - echo "Total files in resources/_gen ->"
        - find resources/_gen -type f 2>/dev/null | wc -l || echo "0"
  artifacts:
    baseDirectory: public
    files:
      - '**/*'
  cache:
    paths:
      - static/img/optimized
