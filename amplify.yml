version: 1
env:
  variables:
    HUGO_VERSION: 0.154.2
    TZ: Asia/Tokyo
    HUGO_CACHEDIR: ${PWD}/.hugo
    OPTIMIZED_IMAGES_DIR: ${PWD}/static/img/optimized
frontend:
  phases:
    preBuild:
      commands:
        - echo "Creating directory for user-specific executable files..."
        - mkdir -p "${HOME}/.local"

        - echo "Installing Hugo ${HUGO_VERSION}..."
        - curl -sLJO "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        - mkdir "${HOME}/.local/hugo"
        - tar -C "${HOME}/.local/hugo" -xf "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        - rm "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
        - export PATH="${HOME}/.local/hugo:${PATH}"

        - echo "Installing libvips for image optimization..."
        - yum install -y vips vips-devel

        - echo "Installing uv..."
        - curl -LsSf https://astral.sh/uv/install.sh | sh
        - export PATH="${HOME}/.local/bin:${PATH}"

        - echo "Verifying installations..."
        - echo "Hugo:" $(hugo version)
        - echo "vips:" $(vips --version)
        - echo "uv:" $(uv --version)

        - echo "Running image optimization (incremental with retry)..."
        - |
          for i in 1 2 3; do
            uv run --with pyvips scripts/optimize_images.py && break
            echo "Retry $i..."
          done
    build:
      commands:
        - echo "Building site..."
        - hugo --gc --minify
  artifacts:
    baseDirectory: public
    files:
      - '**/*'
  cache:
    paths:
      - ${HUGO_CACHEDIR}/**/*
      - ${OPTIMIZED_IMAGES_DIR}/**/*
